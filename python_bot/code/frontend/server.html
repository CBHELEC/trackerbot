<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>Tracker Dashboard | The ultimate Discord bot for Geocachers | Tracker Bot</title>
    <meta name="title" content="Tracker Dashboard | The ultimate Discord bot for Geocachers | Tracker Bot" />
    <meta name="description"
        content="Interactively configure Tracker, the ultimate Discord bot for Geocachers. Show off your stats, share trackables, detect GC and TB codes and have fun with friends, right from your server, anytime." />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://dashboard.trackerbot.xyz" />
    <meta property="og:title" content="Tracker Dashboard | The ultimate Discord bot for Geocachers | Tracker Bot" />
    <meta property="og:description"
        content="Interactively configure Tracker, the ultimate Discord bot for Geocachers. Show off your stats, share trackables, detect GC and TB codes and have fun with friends, right from your server, anytime." />

    <!-- X (Twitter) -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://dashboard.trackerbot.xyz" />
    <meta property="twitter:title"
        content="Tracker Dashboard | The ultimate Discord bot for Geocachers | Tracker Bot" />
    <meta property="twitter:description"
        content="Interactively configure Tracker, the ultimate Discord bot for Geocachers. Show off your stats, share trackables, detect GC and TB codes and have fun with friends, right from your server, anytime." />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/ico" href="/static/favicon.ico">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Form & Input Overrides */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Choices.js Dark Theme Overrides */
        .choices__inner {
            background-color: #0f172a !important;
            border-color: #334155 !important;
            color: #e2e8f0 !important;
            border-radius: 0.5rem !important;
            min-height: 44px;
        }

        .choices__input {
            background-color: transparent !important;
            color: #e2e8f0 !important;
        }

        .choices__list--dropdown,
        .choices__list[aria-expanded] {
            background-color: #1e293b !important;
            border-color: #334155 !important;
            color: #e2e8f0 !important;
        }

        .choices__item--choice {
            color: #cbd5e1 !important;
        }

        .choices__item--choice.is-highlighted {
            background-color: #334155 !important;
        }

        .choices__item--selectable.is-highlighted {
            background-color: #334155 !important;
        }

        .choices__list--multiple .choices__item {
            background-color: #4f46e5 !important;
            border-color: #4338ca !important;
        }

        .choices[data-type*="select-one"] .choices__button {
            filter: invert(1);
            opacity: 0.5;
        }

        /* Toggle Button Styles used by JS */
        .toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            /* gap-2 */
            padding: 0.75rem 1rem;
            /* px-4 py-3 */
            border-radius: 0.75rem;
            /* rounded-xl */
            border: 1px solid #334155;
            /* border-slate-700 */
            background-color: rgba(15, 23, 42, 0.5);
            /* bg-slate-900/50 */
            color: #94a3b8;
            /* text-slate-400 */
            font-weight: 500;
            /* font-medium */
            transition: all 200ms;
            width: 100%;
        }

        .toggle-btn:hover {
            background-color: #1e293b;
            /* bg-slate-800 */
            color: #e2e8f0;
            /* text-slate-200 */
        }

        .toggle-btn.active {
            border-color: rgba(16, 185, 129, 0.5);
            /* border-emerald-500/50 */
            background-color: rgba(16, 185, 129, 0.1);
            /* bg-emerald-500/10 */
            color: #34d399;
            /* text-emerald-400 */
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }

        .toggle-btn:last-child.active {
            border-color: rgba(239, 68, 68, 0.5);
            /* border-red-500/50 */
            background-color: rgba(239, 68, 68, 0.1);
            /* bg-red-500/10 */
            color: #f87171;
            /* text-red-400 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.1);
        }

        .toggle-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Verification Disabled State */
        .verifysettings {
            transition: opacity 300ms ease, filter 300ms ease;
        }

        .verifysettings.disabled {
            opacity: 0.4;
            filter: grayscale(0.8);
            pointer-events: none;
            user-select: none;
        }

        .verify-blocking-overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 300ms ease;
        }

        .verifysettings.disabled+.verify-blocking-overlay,
        .verifysettings.disabled .verify-blocking-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Highlight Animation */
        @keyframes pulseBorder {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
            }
        }

        #verification-enable.highlight {
            animation: pulseBorder 1.5s infinite;
            border-color: #6366f1;
            color: #818cf8;
        }
    </style>
</head>

<body
    class="bg-[#0f172a] text-white selection:bg-indigo-500/30 overflow-x-hidden font-sans antialiased min-h-screen flex flex-col"
    data-verification-enabled="{{ verification_enabled | default(false) | tojson }}">

    <!-- Background Ambience -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div
            class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-600/20 rounded-full blur-[120px] animate-pulse">
        </div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-600/10 rounded-full blur-[120px]"></div>
        <div class="absolute top-[20%] left-[30%] w-[600px] h-[600px] bg-indigo-500/5 rounded-full blur-[100px]"></div>
    </div>
    <div
        class="fixed inset-0 z-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-150 pointer-events-none">
    </div>

    <!-- Navbar -->
    <div
        class="relative z-20 px-6 pt-12 pb-6 block md:flex md:flex-row md:justify-between md:items-center gap-6 w-[95%] 2xl:w-[1800px] mx-auto border-b border-slate-800/50 mb-8">
        <div class="text-left space-y-6 md:space-y-2">
            <div class="flex items-center gap-3 mb-1 justify-start">
                <a href="/guilds"
                    class="inline-flex items-center px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-slate-400 text-xs font-medium hover:text-white hover:border-slate-600 transition-colors">
                    <i data-lucide="arrow-left" class="w-3 h-3 mr-1.5"></i>
                    Back to Guilds
                </a>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white flex items-center gap-3 pr-20 md:pr-0">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">{{ name
                    }}</span>
            </h1>
            <p class="text-slate-400 text-base max-w-lg">Configure settings, manage roles, and toggle features.</p>
        </div>

        <div class="absolute top-10 right-6 md:relative flex items-center gap-4" id="userBox">
            <div class="text-right hidden md:block">
                <p class="text-sm font-semibold text-white">{{global_name}}</p>
                <p class="text-xs text-slate-400">Admin</p>
            </div>
            <button
                class="relative flex items-center justify-center p-0.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 shadow-lg shadow-indigo-500/20 group transition-transform active:scale-95">
                <div class="flex items-center bg-slate-900 rounded-full p-1 group-hover:bg-slate-800 transition-colors">
                    <img src="https://cdn.discordapp.com/avatars/{{user_id}}/{{avatar_hash}}.webp?size=256"
                        class="w-10 h-10 rounded-full object-cover" alt="Avatar">
                    <i data-lucide="chevron-down" id="arrowIcon"
                        class="w-4 h-4 text-slate-400 mx-2 transition-transform duration-200"></i>
                </div>
            </button>
            <div id="dropdownMenu"
                class="hidden absolute right-0 top-full mt-4 w-56 bg-slate-900/95 backdrop-blur-xl border border-slate-700/50 rounded-xl shadow-2xl overflow-hidden z-50 origin-top-right transition-all animate-in fade-in slide-in-from-top-2 duration-200 ring-1 ring-white/5">
                <div class="p-2 space-y-1">
                    <a href="/guilds"
                        class="flex items-center px-3 py-2.5 text-sm font-medium text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors">
                        <i data-lucide="layout-grid" class="w-4 h-4 mr-3"></i>
                        Switch Server
                    </a>
                    <a href="/logout"
                        class="flex items-center px-3 py-2.5 text-sm font-medium text-slate-300 rounded-lg hover:bg-red-500/10 hover:text-red-400 transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4 mr-3"></i>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="relative z-10 w-[95%] 2xl:w-[1800px] mx-auto px-6 pb-20 space-y-10">

        <!-- Section 1: Core Configuration -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Channel Config -->
            <div
                class="bg-slate-900/80 backdrop-blur-xl border border-slate-800 rounded-3xl p-8 flex flex-col gap-6 shadow-xl relative group hover:border-slate-700 transition-colors">
                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="hash" class="w-24 h-24 text-indigo-500"></i>
                </div>
                <div class="h-[90px] flex gap-4">
                    <div class="p-3 rounded-xl bg-indigo-500/10 text-indigo-400 h-fit">
                        <i data-lucide="skull" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Skullboard Channel</h3>
                        <p class="text-sm text-slate-400 mt-1 line-clamp-2">Select the channel where skullboard messages
                            will appear.</p>
                    </div>
                </div>
                <form id="channelForm" class="flex flex-col flex-1 gap-4 relative z-10">
                    <select id="channel" name="channel_id"
                        class="w-full bg-[#0f172a] border border-slate-700 rounded-lg px-4 py-2.5 text-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all min-h-[44px]">
                        <option value="none" {% if feature=='none' or not feature %}selected{% endif %}>ðŸš« Disable
                        </option>
                        {% for channel in channels if not channel.category_id %}
                        {% set is_selected = feature|string == channel.id|string %}
                        <option value="{{ channel.id }}" {% if is_selected %}selected{% endif %}>{{ 'âœ… ' if is_selected
                            else '' }}{{ channel.name }}</option>
                        {% endfor %}
                        {% for category in categories %}
                        <optgroup label="{{ category.name }}" class="bg-slate-900 text-slate-400 font-semibold">
                            {% for channel in category.channels %}
                            {% set is_selected = feature|string == channel.id|string %}
                            <option value="{{ channel.id }}" {% if is_selected %}selected{% endif %}
                                class="text-slate-200">{{ 'âœ… ' if is_selected else '' }}{{ channel.name }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                    <input type="submit" value="Save Channel"
                        class="mt-auto cursor-pointer bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 px-4 rounded-xl transition-colors shadow-lg shadow-indigo-500/20">
                </form>
            </div>

            <!-- Permission Roles -->
            <div
                class="bg-slate-900/80 backdrop-blur-xl border border-slate-800 rounded-3xl p-8 flex flex-col gap-6 shadow-xl relative group hover:border-slate-700 transition-colors">
                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="shield" class="w-24 h-24 text-purple-500"></i>
                </div>
                <div class="h-[90px] flex gap-4">
                    <div class="p-3 rounded-xl bg-purple-500/10 text-purple-400 h-fit">
                        <i data-lucide="lock" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Permission Roles</h3>
                        <p class="text-sm text-slate-400 mt-1 line-clamp-2">Users with these roles can manage bot
                            settings.</p>
                    </div>
                </div>
                <form id="permroleForm" class="flex flex-col flex-1 gap-4 relative z-10">
                    <select id="role" name="role_ids" multiple>
                        {% for role in roles %}
                        <option value="{{ role.id }}" {% if role.id in selected_roles %}selected{% endif %}>{{ role.name
                            }}</option>
                        {% endfor %}
                    </select>
                    <input type="submit" value="Save Roles"
                        class="mt-auto cursor-pointer bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 px-4 rounded-xl transition-colors shadow-lg shadow-indigo-500/20">
                </form>
            </div>
        </div>

        <!-- Section 2: Feature Toggles -->
        <h2 class="text-2xl font-bold text-white mt-12 mb-6 px-2 flex items-center gap-3">
            <span class="w-2 h-8 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
            Feature Control
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Detection -->
            <div
                class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col gap-4 hover:bg-slate-900/80 transition-all">
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded-lg bg-blue-500/10 text-blue-400"><i data-lucide="scan-line"
                            class="w-5 h-5"></i></div>
                    <span class="font-semibold text-slate-200">Code Detection</span>
                </div>
                <div class="toggle-buttons grid grid-cols-2 gap-3 mt-auto">
                    <button id="detection-enable"
                        class="toggle-btn {% if detection_status %}active{% endif %}">Enable</button>
                    <button id="detection-disable"
                        class="toggle-btn {% if not detection_status %}active{% endif %}">Disable</button>
                </div>
            </div>

            <!-- Embeds -->
            <div
                class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col gap-4 hover:bg-slate-900/80 transition-all">
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded-lg bg-pink-500/10 text-pink-400"><i data-lucide="link" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-slate-200">Link Embed Removal</span>
                </div>
                <div class="toggle-buttons grid grid-cols-2 gap-3 mt-auto">
                    <button id="embed-enable" class="toggle-btn {% if embed_status %}active{% endif %}">Enable</button>
                    <button id="embed-disable"
                        class="toggle-btn {% if not embed_status %}active{% endif %}">Disable</button>
                </div>
            </div>

            <!-- Message Commands -->
            <div
                class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col gap-4 hover:bg-slate-900/80 transition-all">
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-400"><i data-lucide="message-square"
                            class="w-5 h-5"></i></div>
                    <span class="font-semibold text-slate-200">Message Commands</span>
                </div>
                <div class="toggle-buttons grid grid-cols-2 gap-3 mt-auto">
                    <button id="message-enable" class="toggle-btn {% if message_set %}active{% endif %}">Enable</button>
                    <button id="message-disable"
                        class="toggle-btn {% if not message_set %}active{% endif %}">Disable</button>
                </div>
            </div>

            <!-- Fun Commands -->
            <div
                class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col gap-4 hover:bg-slate-900/80 transition-all">
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded-lg bg-yellow-500/10 text-yellow-400"><i data-lucide="party-popper"
                            class="w-5 h-5"></i></div>
                    <span class="font-semibold text-slate-200">Fun Commands</span>
                </div>
                <div class="toggle-buttons grid grid-cols-2 gap-3 mt-auto">
                    <button id="fun-enable" class="toggle-btn {% if fun_set %}active{% endif %}">Enable</button>
                    <button id="fun-disable" class="toggle-btn {% if not fun_set %}active{% endif %}">Disable</button>
                </div>
            </div>

            <!-- Code Not Found -->
            <div
                class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 flex flex-col gap-4 hover:bg-slate-900/80 transition-all">
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded-lg bg-red-500/10 text-red-400"><i data-lucide="alert-circle"
                            class="w-5 h-5"></i></div>
                    <span class="font-semibold text-slate-200">'Code Not Found' Message</span>
                </div>
                <div class="toggle-buttons grid grid-cols-2 gap-3 mt-auto">
                    <button id="cnf-enable" class="toggle-btn {% if cnf_status %}active{% endif %}">Enable</button>
                    <button id="cnf-disable"
                        class="toggle-btn {% if not cnf_status %}active{% endif %}">Disable</button>
                </div>
            </div>
        </div>

        <!-- Section 3: Verification System -->
        <div class="mt-12 rounded-3xl border border-slate-800 bg-slate-900/30 overflow-hidden relative">
            <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 pointer-events-none"></div>

            <!-- Header -->
            <div
                class="relative z-20 px-8 pt-7 pb-3 border-b border-slate-800 flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex gap-4">
                    <div class="p-3 rounded-2xl bg-indigo-500/10 text-indigo-400 h-fit">
                        <i data-lucide="badge-check" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Verification System</h2>
                        <p class="text-slate-400 mt-1">Manage automated user verification and role assignments.</p>
                    </div>
                </div>
                <div class="toggle-buttons grid grid-cols-2 gap-3 w-full md:w-auto min-w-[200px]">
                    <button id="verification-enable"
                        class="toggle-btn {% if verification_enabled %}active{% endif %}">Enable</button>
                    <button id="verification-disable"
                        class="toggle-btn {% if not verification_enabled %}active{% endif %}">Disable</button>
                </div>
            </div>

            <!-- Settings Body -->
            <div class="verifysettings p-6 pt-0 space-y-6 relative">
                <!-- Blocking Overlay -->
                <div
                    class="verify-blocking-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-10 cursor-not-allowed rounded-b-3xl flex items-center justify-center">
                    <div
                        class="bg-slate-800/80 px-4 py-2 rounded-full border border-slate-700 text-slate-300 text-sm font-medium shadow-2xl">
                        Verification Disabled
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">

                    <!-- Channel -->
                    <form class="verification-card flex flex-col gap-4 h-full" data-detail="verify_channel_id">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-indigo-500/10 text-indigo-400">
                                <i data-lucide="hash" class="w-5 h-5"></i>
                            </div>
                            <span class="font-semibold text-slate-300 text-sm">Log/Queue Channel</span>
                        </div>
                        <select id="verify-channel" name="verify_channel_id"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2.5 text-slate-200 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="none" {% if verify_channel_id=='none' %}selected{% endif %}>ðŸš« None</option>
                            {% for channel in channels if not channel.category_id %}
                            {% set is_selected = verify_channel_id|string == channel.id|string %}
                            <option value="{{ channel.id }}" {% if is_selected %}selected{% endif %}>{{ 'âœ… ' if
                                is_selected else '' }}{{ channel.name }}</option>
                            {% endfor %}
                            {% for category in categories %}
                            <optgroup label="{{ category.name }}">
                                {% for channel in category.channels %}
                                {% set is_selected = verify_channel_id|string == channel.id|string %}
                                <option value="{{ channel.id }}" {% if is_selected %}selected{% endif %}>{{ 'âœ… ' if
                                    is_selected else '' }}{{ channel.name }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                        <input type="submit" value="Set Channel"
                            class="mt-auto w-full py-2.5 rounded-xl bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 text-indigo-400 text-sm font-semibold transition-all cursor-pointer">
                    </form>

                    <!-- Fasttrack -->
                    <div class="verification-card flex flex-col gap-4 h-full">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-amber-500/10 text-amber-400">
                                <i data-lucide="zap" class="w-5 h-5"></i>
                            </div>
                            <span class="font-semibold text-slate-300 text-sm">Fasttrack Status</span>
                        </div>
                        <div class="toggle-buttons grid grid-cols-2 gap-3">
                            <button id="fasttrack-enable"
                                class="toggle-btn h-[44px] py-0 text-sm {% if verify_fasttrack_status == 1 %}active{% endif %}">Enable</button>
                            <button id="fasttrack-disable"
                                class="toggle-btn h-[44px] py-0 text-sm {% if verify_fasttrack_status == 0 %}active{% endif %}">Disable</button>
                        </div>
                    </div>

                    <!-- Verified Role -->
                    <form class="verification-card flex flex-col gap-4 h-full" data-detail="verify_verified_role_id">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-400">
                                <i data-lucide="shield-check" class="w-5 h-5"></i>
                            </div>
                            <span class="font-semibold text-slate-300 text-sm">Verified Role</span>
                        </div>
                        <select id="verify-verified-role" name="verify_verified_role_id"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2.5 text-slate-200 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if role.id==verify_verified_role_id %}selected{% endif %}>
                                {{ role.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="submit" value="Set Role"
                            class="mt-auto w-full py-2.5 rounded-xl bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 text-indigo-400 text-sm font-semibold transition-all cursor-pointer">
                    </form>

                    <!-- Unverified Role -->
                    <form class="verification-card flex flex-col gap-4 h-full" data-detail="verify_unverified_role_id">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-slate-500/10 text-slate-400">
                                <i data-lucide="shield" class="w-5 h-5"></i>
                            </div>
                            <span class="font-semibold text-slate-300 text-sm">Unverified Role</span>
                        </div>
                        <select id="verify-unverified-role" name="verify_unverified_role_id"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2.5 text-slate-200 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if role.id==verify_unverified_role_id %}selected{% endif
                                %}>{{ role.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="submit" value="Set Role"
                            class="mt-auto w-full py-2.5 rounded-xl bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 text-indigo-400 text-sm font-semibold transition-all cursor-pointer">
                    </form>

                    <!-- Muggle Role -->
                    <form class="verification-card flex flex-col gap-4 h-full" data-detail="verify_muggle_role_id">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-slate-500/10 text-slate-400">
                                <i data-lucide="user" class="w-5 h-5"></i>
                            </div>
                            <span class="font-semibold text-slate-300 text-sm">Muggle Role</span>
                        </div>
                        <select id="verify-muggle-role" name="verify_muggle_role_id"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2.5 text-slate-200 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if role.id==verify_muggle_role_id %}selected{% endif %}>{{
                                role.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="submit" value="Set Role"
                            class="mt-auto w-full py-2.5 rounded-xl bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 text-indigo-400 text-sm font-semibold transition-all cursor-pointer">
                    </form>

                    <!-- Admin Roles (Multi) -->
                    <form class="verification-card flex flex-col gap-4 h-full" data-detail="verify_admin_role_id">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-purple-500/10 text-purple-400">
                                <i data-lucide="shield-alert" class="w-5 h-5"></i>
                            </div>
                            <span class="font-semibold text-slate-300 text-sm">Admin Roles</span>
                        </div>
                        <select id="verify-admin-role" name="verify_admin_role_id" multiple>
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if role.id in verify_admin_role_id %}selected{% endif %}>{{
                                role.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="submit" value="Set Roles"
                            class="mt-auto w-full py-2.5 rounded-xl bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 text-indigo-400 text-sm font-semibold transition-all cursor-pointer">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        // Initialize Icons
        lucide.createIcons();

        // Dropdown Logic
        const userBox = document.getElementById('userBox');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const arrowIcon = document.getElementById('arrowIcon');
        let isOpen = false;

        function toggleDropdown(show) {
            isOpen = show;
            if (show) {
                dropdownMenu.classList.remove('hidden');
                arrowIcon.style.transform = 'rotate(180deg)';
            } else {
                dropdownMenu.classList.add('hidden');
                arrowIcon.style.transform = 'rotate(0deg)';
            }
        }

        userBox.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(!isOpen);
        });

        document.addEventListener('click', (e) => {
            if (isOpen && !userBox.contains(e.target)) {
                toggleDropdown(false);
            }
        });

        // Backend Interaction Logic
        document.addEventListener('DOMContentLoaded', function () {
            const guildId = "{{ id }}";

            async function updateSetting(endpoint, data) {
                try {
                    const response = await fetch(`/server/${guildId}/settings/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        return true;
                    } else {
                        console.error('Failed to update setting');
                        alert('Failed to update setting');
                        return false;
                    }
                } catch (error) {
                    console.error('Error updating setting:', error);
                    alert('Error updating setting');
                    return false;
                }
            }

            function showButtonSuccess(form) {
                const btn = form.querySelector('input[type="submit"]');
                if (!btn) return;
                const originalVal = btn.value;
                const originalBg = btn.style.backgroundColor;
                btn.value = "Saved!";
                btn.style.backgroundColor = "#10b981"; // Emerald-500
                btn.style.color = "white";
                setTimeout(() => {
                    btn.value = originalVal;
                    btn.style.backgroundColor = ""; // reset to CSS class default
                }, 2000);
            }

            function updateSelectVisual(select) {
                if (!select) return;
                for (let i = 0; i < select.options.length; i++) {
                    let opt = select.options[i];
                    let text = opt.text.replace(/^âœ…\s+/, '');
                    if (opt.selected && opt.value !== 'none') {
                        opt.text = 'âœ… ' + text;
                    } else {
                        opt.text = text;
                    }
                }
            }

            const choicesInstancesMap = new Map();

            function initChoice(selector) {
                const el = document.querySelector(selector);
                if (el) {
                    if (el._choicesInstance) {
                        try { el._choicesInstance.destroy(); } catch (e) { }
                    }

                    const choicesInstance = new Choices(el, {
                        removeItemButton: el.hasAttribute('multiple'),
                        searchResultLimit: 10,
                        shouldSort: false,
                        placeholder: true,
                        placeholderValue: 'Select roles...',
                        classNames: {
                            containerOuter: 'choices',
                            containerInner: 'choices__inner',
                        }
                    });
                    choicesInstancesMap.set(selector, choicesInstance);
                    el._choicesInstance = choicesInstance;
                }
            }

            const choiceSelectors = ['#role', '#verify-admin-role'];
            choiceSelectors.forEach(selector => initChoice(selector));

            const channelForm = document.getElementById('channelForm');
            if (channelForm) {
                channelForm.onsubmit = async e => {
                    e.preventDefault();
                    const channelId = document.getElementById('channel').value;
                    if (await updateSetting('set_channel', { channel_id: channelId })) {
                        updateSelectVisual(document.getElementById('channel'));
                        showButtonSuccess(channelForm);
                    }
                };
            }

            const permRoleForm = document.getElementById('permroleForm');
            if (permRoleForm) {
                permRoleForm.onsubmit = async e => {
                    e.preventDefault();
                    const select = document.getElementById('role');
                    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
                    if (await updateSetting('set_perm_roles', { role_ids: selected })) {
                        updateSelectVisual(select);
                        initChoice('#role'); // Re-init to update UI
                        showButtonSuccess(permRoleForm);
                    }
                };
            }

            const verifyForms = [
                { id: 'verify-channel', detail: 'verify_channel_id' },
                { id: 'verify-verified-role', detail: 'verify_verified_role_id' },
                { id: 'verify-unverified-role', detail: 'verify_unverified_role_id' },
                { id: 'verify-muggle-role', detail: 'verify_muggle_role_id' },
                { id: 'verify-admin-role', detail: 'verify_admin_role_id', multi: true }
            ];

            verifyForms.forEach(({ id, detail, multi }) => {
                const el = document.getElementById(id);
                if (!el) return;
                const form = el.closest('form');
                if (!form) return;

                form.onsubmit = async e => {
                    e.preventDefault();
                    let value = multi
                        ? Array.from(el.selectedOptions).map(o => o.value).join(',')
                        : el.value;
                    if (await updateSetting('set_verify', { setting: detail, channel_id: value })) {
                        updateSelectVisual(el);
                        if (id === 'verify-admin-role') {
                            initChoice('#' + id);
                        }
                        showButtonSuccess(form);
                    }
                };
            });

            function setupToggle(enableId, disableId, route) {
                const enable = document.getElementById(enableId);
                const disable = document.getElementById(disableId);
                if (!enable || !disable) return;

                const handleToggle = async (status) => {
                    let success = false;
                    if (route.startsWith('toggle_set/')) {
                        const setting = route.split('/')[1];
                        success = await updateSetting('toggle_set', { set: setting, status: status });
                    } else {
                        success = await updateSetting(route, { status: status });
                    }

                    if (success) {
                        if (status) { // Enable clicked
                            enable.classList.add('active');
                            disable.classList.remove('active');
                        } else { // Disable clicked
                            enable.classList.remove('active');
                            disable.classList.add('active');
                        }
                    }
                };

                enable.addEventListener('click', e => {
                    e.preventDefault();
                    if (!enable.classList.contains('active')) {
                        handleToggle(1);
                    }
                });
                disable.addEventListener('click', e => {
                    e.preventDefault();
                    if (!disable.classList.contains('active')) {
                        handleToggle(0);
                    }
                });
            }

            setupToggle('detection-enable', 'detection-disable', 'toggle_detection');
            setupToggle('embed-enable', 'embed-disable', 'toggle_embed');
            setupToggle('message-enable', 'message-disable', 'toggle_set/message_set');
            setupToggle('fun-enable', 'fun-disable', 'toggle_set/fun_set');
            setupToggle('cnf-enable', 'cnf-disable', 'toggle_set/deadcode');
            setupToggle('fasttrack-enable', 'fasttrack-disable', 'toggle_set/verify_fasttrack_status');
            setupToggle('verification-enable', 'verification-disable', 'toggle_set/verification_status');

            // Wrap handles to trigger UI updates
            const vEnable = document.getElementById('verification-enable');
            const vDisable = document.getElementById('verification-disable');
            if (vEnable && vDisable) {
                const originalEnableClick = vEnable.onclick;
                // We use event listeners in setupToggle, so we can't just overwrite.
                // Instead, we'll just ensure updateVerifySection is called.
            }

            const verifySection = document.querySelector('.verifysettings');
            const verificationEnabled = (() => {
                try {
                    const raw = document.body.dataset.verificationEnabled;
                    return raw === undefined ? false : JSON.parse(raw);
                } catch (e) {
                    return false;
                }
            })();

            function disableChoicesInstances() {
                const choicesContainers = verifySection.querySelectorAll('.choices');
                choicesContainers.forEach(container => {
                    const selectEl = container.querySelector('select');
                    if (selectEl && selectEl._choicesInstance) {
                        try {
                            selectEl._choicesInstance.disable();
                        } catch (e) { }
                    }
                });
            }

            function enableChoicesInstances() {
                const choicesContainers = verifySection.querySelectorAll('.choices');
                choicesContainers.forEach(container => {
                    const selectEl = container.querySelector('select');
                    if (selectEl && selectEl._choicesInstance) {
                        try {
                            selectEl._choicesInstance.enable();
                        } catch (e) { }
                    }
                });
            }

            function updateVerifySection() {
                if (!verifySection) return;
                const isEnabled = document.getElementById('verification-enable').classList.contains('active');

                if (!isEnabled) {
                    verifySection.classList.add('disabled');
                    disableChoicesInstances();
                } else {
                    verifySection.classList.remove('disabled');
                    enableChoicesInstances();
                }
            }

            // Refactor setupToggle to accept a callback for UI updates
            function setupToggleWithCallback(enableId, disableId, route, callback) {
                const enable = document.getElementById(enableId);
                const disable = document.getElementById(disableId);
                if (!enable || !disable) return;

                const handleToggle = async (status) => {
                    let success = false;
                    if (route.startsWith('toggle_set/')) {
                        const setting = route.split('/')[1];
                        success = await updateSetting('toggle_set', { set: setting, status: status });
                    } else {
                        success = await updateSetting(route, { status: status });
                    }

                    if (success) {
                        if (status) {
                            enable.classList.add('active');
                            disable.classList.remove('active');
                        } else {
                            enable.classList.remove('active');
                            disable.classList.add('active');
                        }
                        if (callback) callback();
                    }
                };

                enable.addEventListener('click', e => { e.preventDefault(); if (!enable.classList.contains('active')) handleToggle(1); });
                disable.addEventListener('click', e => { e.preventDefault(); if (!disable.classList.contains('active')) handleToggle(0); });
            }

            // Re-setup the verification toggle with the callback
            setupToggleWithCallback('verification-enable', 'verification-disable', 'toggle_set/verification_status', updateVerifySection);

            // Re-setup other toggles (without callback)
            setupToggleWithCallback('detection-enable', 'detection-disable', 'toggle_detection');
            setupToggleWithCallback('embed-enable', 'embed-disable', 'toggle_embed');
            setupToggleWithCallback('message-enable', 'message-disable', 'toggle_set/message_set');
            setupToggleWithCallback('fun-enable', 'fun-disable', 'toggle_set/fun_set');
            setupToggleWithCallback('cnf-enable', 'cnf-disable', 'toggle_set/deadcode');
            setupToggleWithCallback('fasttrack-enable', 'fasttrack-disable', 'toggle_set/verify_fasttrack_status');

            const overlayElement = document.querySelector('.verify-blocking-overlay');
            if (overlayElement) {
                overlayElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    scrollToEnableButton();
                });
            }

            function scrollToEnableButton() {
                const enableBtn = document.getElementById('verification-enable');
                if (enableBtn) {
                    enableBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    enableBtn.classList.remove('highlight');
                    void enableBtn.offsetWidth; // trigger reflow
                    enableBtn.classList.add('highlight');
                    setTimeout(() => enableBtn.classList.remove('highlight'), 2000);
                }
            }

            // Initial State Check
            updateVerifySection();
        });
    </script>
</body>

</html>